"""django-rules predicates for organization permissions."""

import rules


# Organization predicates
@rules.predicate
def is_org_member(user, org):
    """Check if user is a member of the organization."""
    if not user or not user.is_authenticated:
        return False
    return org.members.filter(user=user).exists()


@rules.predicate
def is_org_admin(user, org):
    """Check if user is an admin of the organization."""
    if not user or not user.is_authenticated:
        return False
    membership = org.members.filter(user=user).first()
    if not membership:
        return False
    return membership.role.permissions.get("*") is True


@rules.predicate
def has_org_permission(user, org, perm):
    """Check if user has a specific permission in the organization."""
    if not user or not user.is_authenticated:
        return False
    membership = org.members.filter(user=user).first()
    if not membership:
        return False
    # Admin role (*: true) has all permissions
    if membership.role.permissions.get("*") is True:
        return True
    # Check specific permission
    return membership.role.permissions.get(perm) is True


# Team predicates
@rules.predicate
def is_team_member(user, team):
    """Check if user is a member of the team."""
    if not user or not user.is_authenticated:
        return False
    return team.members.filter(user=user).exists()


@rules.predicate
def is_team_admin(user, team):
    """Check if user is an admin of the team."""
    if not user or not user.is_authenticated:
        return False
    membership = team.members.filter(user=user).first()
    if not membership:
        return False
    return membership.role.permissions.get("*") is True


@rules.predicate
def is_org_admin_for_team(user, team):
    """Check if user is an org admin (cascading permissions)."""
    if not user or not user.is_authenticated:
        return False
    return is_org_admin(user, team.organisation)


@rules.predicate
def has_team_permission(user, team, perm):
    """Check if user has a specific permission in the team."""
    if not user or not user.is_authenticated:
        return False
    # Org admin has all permissions on team
    if is_org_admin_for_team(user, team):
        return True
    # Check team membership
    membership = team.members.filter(user=user).first()
    if not membership:
        return False
    # Admin role (*: true) has all permissions
    if membership.role.permissions.get("*") is True:
        return True
    # Check specific permission
    return membership.role.permissions.get(perm) is True
